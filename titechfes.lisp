(in-package :titechfes)

;------------------main------------------
(defun main ()
  (sdl:with-init ()
    (sdl:window 640 480 :title-caption "魔津村")
    (setf (sdl:frame-rate) 60)
    (load-images '(:wall "wall_g.png")
		 '(:bullet "knife.png")
		 '(:player-l "me2.png")
		 '(:player-r "me.png")
		 '(:enemy-l "enemy2.png")
		 '(:enemy-r "enemy.png"))
    (let ((game (make-instance 'game)))
      (load-map (lib-path "map.txt") game)
      (init-camera game)
      (sdl:update-display)
      (sdl:with-events ()
	(:quit-event () t)
	(:video-expose-event () (sdl:update-display))
	(:key-down-event (:key key)
			 (if (sdl:key= key :sdl-key-escape)
			     (sdl:push-quit-event)
			     (update-key-state key t 
				(keystate game))))
	(:key-up-event (:key key)
		       (update-key-state key nil
			   (keystate game)))
	(:idle (update-all game)
	       (update-camera game)
	       (when (not (alive (player game)))
		 (sdl:push-quit-event))
	       (sdl:clear-display sdl:*black*)
	       (draw-all game)
	       (sdl:update-display))))))
